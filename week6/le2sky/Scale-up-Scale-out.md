# 스케일 업과 스케일 아웃

## 스케일 업

- **스케일 업**은 기존의 서버를 보다 높은 사양으로 업그레이드 하는 것이다.
- 성능이나 용량 증강을 목적으로 하나의 서버에 디스크를 추가하거나 CPU, 메모리를 업그레이드 시키는 것
- **수직 스케일링(vertical scaling)** 이라고도 함

## 스케일 아웃

- **스케일 아웃** 은 장비를 추가해서 확장하는 방식을 말한다.
- 비슷한 사양의 서버를 추가로 연결해 처리할 수 있는 트래픽을 증가시키며, 기존 서버의 부하를 분담해 성능을 향상시킨다.
- **수평 스케일링(horizontal scaling)** 이라고도 함

## 비교

|        | 스케일 업                                                     | 스케일 아웃                                                              |
| ------ | ------------------------------------------------------------- | ------------------------------------------------------------------------ |
| 방식   | 사양 업그레이드                                               | 비슷한 사양의 서버를 추가                                                |
| 확장성 | 하드웨어 장비의 성능을 높이는데, <br> 성능 확장에 한계가 존재 | 수평 확장으로 지속적으로 확장 가능함(확장의 유연성)                      |
| 비용   | 성능 증가에 따른 비용 증가폭이 큼, 하지만 관리 비용이 적음    | 비교적 저렴한 서버 사용으로 비용 부담이 적음                             |
| 장애   | 한 대의 서버에 부하가 집중되어 장애 영향도가 큼               | 읽기/쓰기가 여러 대의 서버에 분산 처리 장애 시 전면 장애의 가능성이 적음 |

## 꼬리, OLTP와 OLAP 각 상황에서 어떤 인프라 확장 방식을 고려할 수 있나요?

주로 대용량의 데이터에 대해 처리하고, 보다 복잡한 데이터 처리를 통해 의미를 추출하는데 중점을 두는 OLAP(Online Analytical Processing) 환경에서는 스케일아웃 구성이 더 효율적이다.

반면, 네트워크 상의 온라인 사용자들의 데이터베이스에 대한 일괄 트랜잭션 처리를 하는 OLTP(Online Transaction Processing) 환경에서는 스케일업 구성이 더 효율적이다. 즉, 온라인 금융거래와 같이 워크플로우 기반에 빠르고 정확하고, 단순한 처리가 필요한 경우 고성능의 스케일업 방식이 적합하다.

## 꼬리, 스케일 아웃 확장 구조에서 세션 불일치 문제와 해결 방법

스케일 아웃 확장을 통해 여러 대의 서버로 요청을 처리하도록 분산 서버 환경을 만들면 각 서버 별로 세션 정보가 다른 상황을 세션 불일치 문제라고 한다.

이때 해결 방법으로 한 서버에만 요청을 보내도록 고정하는 방법을 `Sticky Session`이라 하며, 세션 정보를 모든 서버에 공유하는 방법을 `Session Clustering`이라고 한다.

Sitcky Session 방식은 쿠키 값이나 IP 세부 정보를 기반으로 동일 클라이언트 인지 판단하고, 세션이 생성된 서버로 라우팅한다. 이 방식의 단점은 트래픽이 한 곳에 몰릴 수 있다. 이는 곧 스케일 아웃의 장점인 서버의 가용성을 최대한 활용 하지 못하는 상황이 발생한다. (또한, 서버 장애 발생 시 다른 서버에서 세션 인증을 다시해야함)

Session Clustering은 Tomcat에서 제공해주는 방법을 이용하거나, 외부 리소스에 저장해서 공유하는 방법이 있다. Tomcat을 이용하는 방법 중 첫 번째는 `All-to-All Session Replication`이다. 이는 Tomcat에서 제공하는 DeltaManager가 생성된 세션을 모든 서버에 복제하는 방법이다. 이러한 방식은 복제를 위한 트래픽이 발생하며, 서버가 늘어날수록 서버가 감당해야할 세션과 복제 트래픽이 증가한다는 단점이 존재한다. (소규모 클러스터 환경, 노드 4개 미만 일떄 권장)

위와 같은 문제를 해결하기 위해서 `Primary-secondary session replication` 방식을 사용할 수 있다. 이는 BackupManager를 사용하며, 세션을 모든 서버에 복제하지 않고, 백업 서버에만 복제하는 방식이다. 클라이언트 요청이 들어오면 해당 요청을 처리한 Primary 서버에 세션을 생성, Secondary 서버에만 완전한 세션을 복제한다. 나머지 Proxy 서버에는 session ID와 Primary/Secondary 서버의 주소만 가지고 있다. 나중에 Proxy 서버에 요청이 들어오면, Primary 서버에 요청을 보내 완전한 세션 데이터를 복제한다.

이 방법은 저장해야할 세션 정보의 양이 상대적으로 줄어든다는 장점이있으며, 단점으로는 완전한 세션 복제를 위한 과정이 수행된다는 점이다. (proxy로 갔을 때)

추가적으로 외부 스토리지를 이용하기 위해서는 tomcat의 PersistentManager를 이용해 파일시스템과 데이터베이스에 세션 정보를 기록할 수 있다.
