### N+1 ë¬¸ì œë€?

N+1 ë¬¸ì œë€ 1ê°œì˜ ì¿¼ë¦¬ë¡œ ì²˜ë¦¬ë˜ê¸¸ ê¸°ëŒ€í–ˆì§€ë§Œ Nê°œì˜ ì¶”ê°€ ì¿¼ë¦¬ê°€ ë°œìƒí•˜ëŠ” í˜„ìƒìœ¼ë¡œ, ì²˜ìŒ ì‹¤í–‰í•œ SQLì˜ ê²°ê³¼ ìˆ˜ë§Œí¼ ì¶”ê°€ë¡œ SQLì´ ì‹¤í–‰ë˜ëŠ” ê²ƒì„ ë§í•œë‹¤. ì´ê²ƒì€ ì—°ê´€ê´€ê³„ê°€ ì„¤ì •ë˜ì–´ ìˆëŠ” ì—”í‹°í‹°ë¥¼ JPQLì„ í†µí•´ ì¡°íšŒí•˜ëŠ” ê²½ìš°ì— ë°œìƒí•˜ëŠ” ë¬¸ì œë‹¤. 
JPQLì„ ì‹¤í–‰í•˜ë©´ JPAê°€ JPQLì„ ë¶„ì„í•˜ì—¬ SQLì„ ìƒì„±í•´ì£¼ëŠ”ë°, ì´ë•Œ ì—°ê´€ê´€ê³„ì™€ ì¦‰ì‹œ ë¡œë”©, ì§€ì—° ë¡œë”©ì— ëŒ€í•´ì„œëŠ” ì „í˜€ ì‹ ê²½ì“°ì§€ ì•Šê³  ì—”í‹°í‹° ê¸°ì¤€ìœ¼ë¡œë§Œ SQL ì¿¼ë¦¬ë¥¼ ìƒì„±í•˜ê²Œ ëœë‹¤.

ì¦‰ì‹œ ë¡œë”©, ì§€ì—° ë¡œë”© ëª¨ë‘ì—ì„œ N+1 ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆë‹¤.

**ì¦‰ì‹œ ë¡œë”©ì—ì„œì˜ N+1 ë¬¸ì œ**

Member ì—”í‹°í‹°, Order ì—”í‹°í‹°ê°€ 1:N ì–‘ë°©í–¥ ì—°ê´€ê´€ê³„ ì„¤ì •ì´ ë˜ì–´ìˆë‹¤ê³  í•˜ì.

```java
@Entity
@Table(name = "orders")
public class Order {
    @ManyToOne
    private Member member;
    ...
}

@Entity
public class Member {
    @OneToMany(mappedBy = "member", fetch = FetchType.EAGER)
    private List<Order> orders = new ArrayList<Order>();
    ...
}
```

ì—°ê´€ê´€ê³„ê°€ ì¦‰ì‹œ ë¡œë”©(fetch = FetchType.EAGER)ìœ¼ë¡œ ì„¤ì •ë˜ì–´ ìˆëŠ” ê²½ìš°, ìš°ì„  í•´ë‹¹ ì—”í‹°í‹°ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•œ í›„ì— ë°”ë¡œ ì´ì–´ì„œ ì—°ê´€ëœ ì—”í‹°í‹°ë¥¼ ì¡°íšŒí•˜ëŠ” ì¿¼ë¦¬ê°€ ì¶”ê°€ë¡œ ì‹¤í–‰ëœë‹¤. 

ë™ì‘ ê³¼ì •

```java
memberRepository.findAll()
```

1. findAll()ì„ í•œ ìˆœê°„ select m from Member m ì´ë¼ëŠ” JPQL êµ¬ë¬¸ì´ ìƒì„±ë˜ê³  í•´ë‹¹ êµ¬ë¬¸ì„ ë¶„ì„í•œ `select * from member` ì´ë¼ëŠ” SQLì´ ìƒì„±ë˜ì–´ ì‹¤í–‰ëœë‹¤. 
2. DBì˜ ê²°ê³¼ë¥¼ ë°›ì•„ member ì—”í‹°í‹°ì˜ ì¸ìŠ¤í„´ìŠ¤ë“¤ì„ ìƒì„±í•œë‹¤.
3. memberì™€ ì—°ê´€ë˜ì–´ ìˆëŠ” order ë„ ë¡œë”©ì„ í•´ì•¼ í•œë‹¤.
4. ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œ ì—°ê´€ëœ orderê°€ ìˆëŠ”ì§€ í™•ì¸í•œë‹¤.
5. ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì—†ë‹¤ë©´ 2ì—ì„œ ë§Œë“¤ì–´ì§„ member ì¸ìŠ¤í„´ìŠ¤ë“¤ ê°œìˆ˜ì— ë§ê²Œ `select * from order where member_id = ?` ì´ë¼ëŠ” SQL êµ¬ë¬¸ì´ ìƒì„±ëœë‹¤. **(N+1 ë°œìƒ)**


**ì§€ì—° ë¡œë”©ì—ì„œì˜ N+1 ë¬¸ì œ**

```java
@Entity
@Table(name = "orders")
public class Order {
    @ManyToOne
    private Member member;
    ...
}

@Entity
public class Member {
    @OneToMany(mappedBy = "member", fetch = FetchType.LAZY)
    private List<Order> orders = new ArrayList<Order>();
    ...
}
```

ì§€ì—°ë¡œë”©ì˜ ê²½ìš° ì—”í‹°í‹° ì¡°íšŒ ë‹¹ì‹œì—ëŠ” N+1 ë¬¸ì œê°€ ë°”ë¡œ ë°œìƒí•˜ì§€ëŠ” ì•Šì§€ë§Œ, ì´í›„ì— ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì—ì„œ ì—°ê´€ëœ ì—”í‹°í‹°ë¥¼ ì‹¤ì œë¡œ ì‚¬ìš©í•  ë•Œ ì¶”ê°€ë¡œ ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•˜ê²Œ ëœë‹¤.

ë™ì‘ ê³¼ì •

1. findAll()ì„ í•œ ìˆœê°„ select m from Member m ì´ë¼ëŠ” JPQL êµ¬ë¬¸ì´ ìƒì„±ë˜ê³  í•´ë‹¹ êµ¬ë¬¸ì„ ë¶„ì„í•œ `select * from member` ì´ë¼ëŠ” SQLì´ ìƒì„±ë˜ì–´ ì‹¤í–‰ëœë‹¤.
2. DBì˜ ê²°ê³¼ë¥¼ ë°›ì•„ member ì—”í‹°í‹°ì˜ ì¸ìŠ¤í„´ìŠ¤ë“¤ì„ ìƒì„±í•œë‹¤.
3. ì½”ë“œ ì¤‘ì—ì„œ member ì˜ order ê°ì²´ë¥¼ ì‚¬ìš©í•˜ë ¤ê³  í•˜ëŠ” ì‹œì ì— ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œ ì—°ê´€ëœ orderê°€ ìˆëŠ”ì§€ í™•ì¸í•œë‹¤.
4. ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì—†ë‹¤ë©´ order ê°ì²´ë¥¼ ì‚¬ìš©í•˜ë ¤ëŠ” member ì¸ìŠ¤í„´ìŠ¤ë“¤ ê°œìˆ˜ì— ë§ê²Œ `select * from order where member_id = ?` ì´ë¼ëŠ” SQL êµ¬ë¬¸ì´ ìƒì„±ëœë‹¤. **(N+1 ë°œìƒ)**

---

### í•´ê²° ë°©ë²•

**1. fetch join**

í˜ì¹˜ ì¡°ì¸ì€ `SQL ì¡°ì¸` ì„ ì‚¬ìš©í•´ì„œ ì—°ê´€ëœ ì—”í‹°í‹°ë¥¼ í•¨ê»˜ ì¡°íšŒí•˜ì—¬ N+1 ë¬¸ì œê°€ ë°œìƒí•˜ì§€ ì•ŠëŠ”ë‹¤.

JPQL

```sql
select m from Member m join fetch m.orders
```

ì‹¤í–‰ë˜ëŠ” SQL

```sql
select m.*, o.* from member m
	inner join orders o on m.id=o.member_id
```

í•œê³„

1. íŒ¨ì¹˜ ì¡°ì¸ ëŒ€ìƒì—ëŠ” ë³„ì¹­ì„ ì¤„ ìˆ˜ ì—†ë‹¤.
2. ë‘˜ ì´ìƒì˜ ì»¬ë™ì…˜ì„ íŒ¨ì¹˜í•  ìˆ˜ ì—†ë‹¤.
3. ì»¬ë™ì…˜ì„ íŒ¨ì¹˜ ì¡°ì¸í•˜ë©´ í˜ì´ì§• APIë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ë‹¤.

> ğŸ’¡ **ì»¬ë ‰ì…˜ íŒ¨ì¹˜ ì¡°ì¸ê³¼ í˜ì´ì§•**
>
> ì»¬ë ‰ì…˜ì„ fetch joiní•˜ê²Œ ë˜ë©´ **í˜ì´ì§•ì´ ë¶ˆê°€ëŠ¥**í•˜ë‹¤. fetch joinì„ í†µí•´ ê°€ì ¸ì˜¨ ë°ì´í„°ëŠ” ì»¬ë ‰ì…˜ì˜ ê°œìˆ˜ì— ë”°ë¼ rowê°€ ì¦ê°€í•˜ê¸° ë•Œë¬¸ì´ë‹¤. 
> í˜ì´ì§•ì„ ì‚¬ìš©í•˜ê³  ì‹¶ì€ ê²½ìš°ëŠ”, row ìˆ˜ì— ì˜í–¥ì„ ë¯¸ì¹˜ì§€ ì•Šë„ë¡ ToOne ê´€ê³„ë§Œ fetch join ìœ¼ë¡œ ê°€ì ¸ì˜¤ê³  ì»¬ë ‰ì…˜ì€ ì§€ì—° ë¡œë”©ìœ¼ë¡œ ì¡°íšŒí•˜ì. ì´ë•Œ ì§€ì—° ë¡œë”©ì˜ ì„±ëŠ¥ ìµœì í™”ë¥¼ ìœ„í•´ ì•„ë˜ì— ë‚˜ì˜¤ëŠ” @BatchSizeë¥¼ ì‚¬ìš©í•˜ì.


**2. í•˜ì´ë²„ë„¤ì´íŠ¸ @BatchSize**

org.hibernate.annotations.BatchSize ì–´ë…¸í…Œì´ì…˜ì€ ì—°ê´€ëœ ì—”í‹°í‹°ë¥¼ ì¡°íšŒí•  ë•Œ ì§€ì •í•œ sizeë§Œí¼ `SQL IN ì ˆ` ì„ ì‚¬ìš©í•´ì„œ ì¡°íšŒí•œë‹¤. ì˜ˆë¥¼ ë“¤ì–´, ì¡°íšŒí•œ íšŒì›ì´ 10ëª…ì´ê³  size=5ë¼ë©´ 2ë²ˆì˜ SQLë§Œ ì¶”ê°€ë¡œ ì‹¤í–‰ëœë‹¤.

```java
@Entity
public class Member {
	@BatchSize(size=5)
    @OneToMany(mappedBy = "member", fetch = FetchType.EAGER)
    private List<Order> orders = new ArrayList<Order>();
    
    ...
}
```

ì‹¤í–‰ë˜ëŠ” SQL

```sql
select * from member;

select * from orders where member_id in (?,?,?,?,?);

select * from orders where member_id in (?,?,?,?,?);
```

> ğŸ’¡ **hibernate.default_batch_fetch_size**
> hibernate.default_batch_fetch_size ì†ì„±ì„ ì‚¬ìš©í•˜ë©´ ì• í”Œë¦¬ì¼€ì´ì…˜ ì „ì²´ì— ê¸°ë³¸ìœ¼ë¡œ `@BatchSize` ë¥¼ ì ìš©í•  ìˆ˜ ìˆë‹¤.
> default_batch_fetch_size ì˜ í¬ê¸°ëŠ” ì ë‹¹í•œ ì‚¬ì´ì¦ˆë¥¼ ê³¨ë¼ì•¼ í•˜ëŠ”ë°, `100~1000` ì‚¬ì´ë¥¼ ì„ íƒí•˜ëŠ” ê²ƒì„ ê¶Œì¥í•œë‹¤. 
> ëŒ€ë¶€ë¶„ì˜ DBì—ì„œ INì ˆì˜ ìµœëŒ€ ê°œìˆ˜ê°€ 1000ê°œë¡œ ì œí•œë˜ì–´ ìˆê¸° ë•Œë¬¸ì—, ê¸°ë³¸ì ìœ¼ë¡œ Batch Sizeì˜ ê°’ì„ 1000 ì´í•˜ë¡œ ì„¤ì •í•´ì•¼ í•œë‹¤.
> application.yml 
```yaml
spring:
  jpa:
    properties:
      hibernate:
        default_batch_fetch_size: 1000 
```


**3. í•˜ì´ë²„ë„¤ì´íŠ¸ @Fetch(FetchMode.SUBSELECT)**

org.hibernate.annotations.Fetch ì–´ë…¸í…Œì´ì…˜ì— FetchModeë¥¼ SUBSELECTë¡œ ì‚¬ìš©í•˜ë©´ ì—°ê´€ëœ ë°ì´í„°ë¥¼ ì¡°íšŒí•  ë•Œ `ì„œë¸Œ ì¿¼ë¦¬` ë¥¼ ì‚¬ìš©í•´ì„œ N+1 ë¬¸ì œë¥¼ í•´ê²°í•œë‹¤.


```java
@Entity
public class Member {
	@Fetch(FetchMode.SUBSELECT)
    @OneToMany(mappedBy = "member", fetch = FetchType.EAGER)
    private List<Order> orders = new ArrayList<Order>();
    
    ...
}
```

ì¦‰ì‹œ ë¡œë”©ìœ¼ë¡œ ì„¤ì •í•˜ë©´ ì¡°íšŒ ì‹œì ì—, ì§€ì—° ë¡œë”©ìœ¼ë¡œ ì„¤ì •í•˜ë©´ ì§€ì—° ë¡œë”©ëœ ì—”í‹°í‹°ë¥¼ ì‚¬ìš©í•˜ëŠ” ì‹œì ì— ì¶”ê°€ë¡œ ì„œë¸Œ ì¿¼ë¦¬ë¥¼ ì‚¬ìš©í•˜ëŠ” SQLì´ ì‹¤í–‰ëœë‹¤.

ì‹¤í–‰ë˜ëŠ” SQL

```sql
select * from member;

select * 
from orders o
where o.member_id in (select m.id from member m);
```


**4. @EntityGraph**

ì—”í‹°í‹° ê·¸ë˜í”„ ê¸°ëŠ¥ì€ `SQL ì¡°ì¸` ì„ í†µí•´ ì—”í‹°í‹°ë¥¼ ì¡°íšŒí•˜ëŠ” ì‹œì ì— ì—°ê´€ëœ ì—”í‹°í‹°ë“¤ì„ í•¨ê»˜ ì¡°íšŒí•œë‹¤. fetch joinê³¼ ìœ ì‚¬í•˜ì§€ë§Œ `left outer join` ë§Œ ì§€ì›í•œë‹¤ëŠ” ì°¨ì´ê°€ ìˆë‹¤.

```java
public interface MemberRepository extends JpaRepository<Member, Long> {

	@Override
	@EntityGraph(attributePaths = {"orders"}, 
				type = EntityGraphType.LOAD)
	List<Member> findAll();
}
```

- `attributePaths` : í•¨ê»˜ ì¡°íšŒí•  ì—”í‹°í‹°ë¥¼ ì¶”ê°€í•œë‹¤. ë³µìˆ˜ ê°€ëŠ¥.
- `type` 
	
    - `EntityGraphType.FETCH` (default) : attributeëŠ” EAGERë¡œ íŒ¨ì¹˜í•˜ê³ , ë‚˜ë¨¸ì§€ attributeëŠ” LAZYë¡œ íŒ¨ì¹˜í•œë‹¤.
    - `EntityGraphType.LOAD` : ëª…ì‹œí•œ attributeëŠ” EAGERë¡œ íŒ¨ì¹˜í•˜ê³ , ë‚˜ë¨¸ì§€ attributeëŠ” entityì— ëª…ì‹œí•œ fetch typeì´ë‚˜ ë””í´íŠ¸ FetchTypeìœ¼ë¡œ íŒ¨ì¹˜í•œë‹¤. (e.g. @OneToManyëŠ” LAZY, @ManyToOneì€ EAGERê°€ ë””í´íŠ¸)

ì‹¤í–‰ë˜ëŠ” SQL

```sql
select m.*, o.* from member m
	left outer join orders o on m.id=o.member_id
```